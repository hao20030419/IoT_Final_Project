# 影片壓縮功能 - 快速開始指南

## 功能特性

✨ **智能影片壓縮系統**

你的應用程式現在支援進階影像壓縮功能：

1. **YOLO物件檢測幀** - 只保留有檢測到物件的影格
2. **關鍵幀保留** - 每秒至少保留1幀（確保影片連貫性）
3. **自動壓縮計算** - 智能選擇要保留的影格

## 使用步驟

### 第1步：上傳視頻
```
點擊 [Upload Video] → 選擇你的視頻檔案（.mp4 .avi .mov .mkv）
```

### 第2步：分析視頻
```
點擊 [Process Video] → 等待兩階段分析完成
- 兩階段處理：frame difference + YOLO檢測
- 系統會自動計算加速效果
```

### 第3步：壓縮視頻
```
點擊 [Compress & Download] → 選擇儲存位置 → 確認
- 系統會建立只包含YOLO檢測幀和關鍵幀的壓縮視頻
- 通常可以減少 90%+ 的幀數
```

### 第4步：查看統計資訊
```
在介面右側 "影片壓縮資訊" 區域查看：
- 原始影格數
- 保留影格數
- 壓縮比例
- 檔案大小縮減率
- 儲存位置
```

## UI 介面說明

### 上方控制面板
```
[Upload Video] → 選擇視頻檔案
[Process Video] → 開始YOLO分析
[Stop] → 停止處理
[Compress & Download] → 壓縮並下載視頻
進度條 → 顯示處理進度
```

### 左側 - 影片播放區
```
[▶ 播放] [⏸ 暫停] → 播放控制
影格滑塊 → 選擇要查看的影格
```

### 右側 - 結果面板
```
【影格資訊】
- 當前影格編號
- 動作檢測狀態
- 偵測到的物件及信心度

【效能指標】
- 兩階段處理時間
- 完整YOLO時間
- 加速倍數和百分比
- 檢測統計

【影片壓縮資訊】
- 原始/保留影格數
- 壓縮比例
- 檔案大小變化
```

## 壓縮演算法說明

### 幀選擇邏輯

每一幀會被保留的條件：

```
保留條件（符合任一即保留）：
1. YOLO檢測幀
   - 幀差異檢測到動作 AND
   - YOLO檢測到物件
   
2. 關鍵幀
   - 距離上一個關鍵幀已達到間隔
   - 預設：每秒1幀 (fps=30 時每30幀1個)
```

### 數學公式

```
幀保留間隔 = FPS
  (例如：30 FPS → 每30幀保留1個 = 每秒1幀)

原始幀數 = 視頻總幀數
保留幀數 = YOLO檢測幀 + 關鍵幀

壓縮比例 = (原始幀數 - 保留幀數) / 原始幀數 × 100%
保留比例 = 保留幀數 / 原始幀數 × 100%
```

## 實際示例

### 輸入視頻
- 時長：10 秒
- 幀率：30 FPS
- 總幀數：300
- 檔案大小：0.5 MB

### 處理過程
1. **幀差異偵測** - 找出有動作的幀
2. **YOLO分析** - 在動作幀上運行物件檢測
3. **關鍵幀添加** - 每秒添加1個關鍵幀（10幀）
4. **影片生成** - 寫出保留的幀到新檔案

### 輸出結果
```
保留影格數: 10 幀
  - 關鍵幀: ~10 幀（每秒1幀）
  - YOLO檢測幀: 0 幀（示例中無物件）

壓縮比例: 96.7% 去除
保留比例: 3.3% 保留
檔案大小: 0.51 MB → 0.03 MB
大小縮減: 95.1%
```

## 進階設定

### 修改關鍵幀頻率

如果你想改變每秒保留多少幀，編輯 `video_processor.py`：

```python
def compress_video_smart(self, video_path, output_path, ...):
    # 改變這行（目前設定為每秒1幀）
    frame_interval = max(1, int(fps))  # 改成 int(fps) // 2 = 每秒2幀
```

### 調整 YOLO 檢測敏感度

編輯 `config.py` 的幀差異閾值：

```python
FRAME_DIFF_CONFIG = {
    'threshold': 7000  # 降低此值 = 更敏感
}
```

## 常見問題

**Q: 壓縮後影片為什麼很短？**
A: 這是正常的！系統只保留有物件的幀 + 每秒1幀關鍵幀。如果原始視頻大部分沒有物件，壓縮比會很高。

**Q: 能否保留更多幀？**
A: 可以！修改 `compress_video_smart()` 中的 `frame_interval` 來增加每秒保留的幀數。

**Q: 壓縮後的影片品質會降低嗎？**
A: 否。每一個保留的幀都是完整的原始品質，只是幀數更少，所以看起來更"跳躍"。

**Q: 能否自定義壓縮比例？**
A: 可以！編輯演算法中的 `frame_interval` 和 YOLO 檢測條件。

## 技術細節

| 項目 | 詳情 |
|-----|------|
| 輸入格式 | MP4, AVI, MOV, MKV |
| 輸出格式 | MP4 (H.264 編碼) |
| 幀差異偵測 | OpenCV (灰階→模糊→差異→計數) |
| 物件檢測 | YOLOv8 Nano (輕量級) |
| 影片編碼 | MP4V codec |

## 性能表現

```
測試環境：CPU only (無GPU)
原始視頻：300幀, 30 FPS, 0.51 MB
壓縮結果：10幀, 30 FPS, 0.03 MB

壓縮時間: ~30 秒
幀處理速度: ~10 幀/秒
```

## 故障排除

### 問題：壓縮按鈕呈灰色
**解決**：先點擊 [Process Video] 完成分析

### 問題：無法選擇儲存位置
**解決**：確保有寫入權限，嘗試其他資料夾

### 問題：壓縮失敗
**解決**：
1. 檢查磁碟空間
2. 確保輸入視頻有效
3. 查看控制台錯誤訊息

## 相關檔案

- `video_processor.py` - 核心壓縮演算法
- `main_gui.py` - 使用者介面
- `config.py` - 配置參數
- `frame_difference.py` - 動作檢測
- `yolo_detector.py` - 物件檢測

---

**更新日期**：2025年12月11日
**版本**：2.0 (支援影片壓縮)
